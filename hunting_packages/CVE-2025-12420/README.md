# Hunting Package — CVE-2025-12420 (BodySnatcher / ServiceNow Agentic AI)

## Overview

A defender-oriented guide to detect suspicious behavior patterns associated with the publicly reported ServiceNow agentic AI authentication weakness.

This package is behavior-based because the public report does not provide reusable network IOCs.

---

## Scope

Applies when you have one or more of:
- ServiceNow on-prem with affected versions
- Virtual Agent / Now Assist AI Agents enabled
- External agent / agent-to-agent integration enabled
- Auditable logs for user/role changes and agent workflow executions

---

## Primary Hunt Hypotheses

**H1) Agent session correlated user creation**
- New user created within minutes of a Virtual Agent / Now Assist conversation

**H2) Agent session correlated privilege assignment**
- New user gets admin-like role soon after creation (especially if created_by is a system/integration context)

**H3) Follow-on account recovery**
- Password reset / account recovery events for newly created accounts shortly after creation

**H4) Integration governance drift**
- New/changed agent provider configuration preceding suspicious identity or privilege events

---

## Required Telemetry (Minimum Viable)

- User management audit logs (create/update)
- Role assignment audit logs
- Password reset / account recovery logs
- Virtual Agent / Now Assist conversation/session logs (metadata at least)
- Agent workflow/tool execution logs (if available)
- Configuration change logs for agent providers / integrations

---

## "What Good Looks Like"

A confirmed signal typically includes:
- A chain from **agent activity** → **identity change** → **privilege** → **authentication event** with consistent timestamps and accountable principals.

---

## Hunt Queries

> These are templates. Adapt field/table names to your logging pipeline.
> Prefer correlation searches over single-event matches.

### A) Core Correlation Logic (Pseudocode)

**Goal:** Detect when agent activity precedes privileged identity changes.

1. Identify agent sessions (Virtual Agent / Now Assist) with session_id, user_identity, timestamp
2. Identify identity change events:
   - user created
   - user updated (email / identity binding changes)
   - role granted (especially admin-like roles)
   - password reset / account recovery
3. Join by:
   - time window (e.g., 0–30 minutes)
   - actor / created_by principal (system/integration/service account)
   - target identity (email/username) if present
4. Alert on:
   - new user + privileged role
   - role grants from agent-linked workflows
   - bursts of similar actions across multiple identities

---

### B) Generic SQL Template (Analytics / Lake / SIEM Backend)

**Assumptions:**
- `agent_sessions(session_id, user_email, started_at, source)`
- `audit_events(event_time, event_type, actor, target, target_email, details_json)`
- `auth_events(event_time, user, action, source_ip, result)`

#### 1) New users created near agent sessions

```sql
SELECT
  a.session_id,
  a.user_email AS session_user,
  e.event_time,
  e.actor,
  e.target AS new_user,
  e.target_email
FROM agent_sessions a
JOIN audit_events e
  ON e.event_time BETWEEN a.started_at AND a.started_at + INTERVAL '30' MINUTE
WHERE e.event_type IN ('user_create','sys_user_insert')
;
```

#### 2) Role grants to new users near agent sessions (high-signal)

```sql
SELECT
  a.session_id,
  e1.target AS new_user,
  e2.details_json AS role_grant_details,
  e2.actor AS role_grant_actor,
  e2.event_time AS role_grant_time
FROM agent_sessions a
JOIN audit_events e1
  ON e1.event_time BETWEEN a.started_at AND a.started_at + INTERVAL '30' MINUTE
  AND e1.event_type IN ('user_create','sys_user_insert')
JOIN audit_events e2
  ON e2.target = e1.target
  AND e2.event_time BETWEEN e1.event_time AND e1.event_time + INTERVAL '30' MINUTE
  AND e2.event_type IN ('role_grant','sys_user_has_role_insert')
WHERE LOWER(CAST(e2.details_json AS VARCHAR)) LIKE '%admin%'
;
```

#### 3) Password reset shortly after user creation (follow-on)

```sql
SELECT
  e_create.target AS user_created,
  e_reset.event_time AS reset_time,
  e_reset.actor AS reset_actor,
  e_reset.details_json
FROM audit_events e_create
JOIN audit_events e_reset
  ON e_reset.target = e_create.target
  AND e_reset.event_time BETWEEN e_create.event_time AND e_create.event_time + INTERVAL '2' HOUR
WHERE e_create.event_type IN ('user_create','sys_user_insert')
  AND e_reset.event_type IN ('password_reset','account_recovery')
;
```

---

### C) Splunk (SPL) Sketch

> Replace `index=` and sourcetypes with your ServiceNow feed.

#### 1) New user + admin-like role within 30 minutes

```spl
(index=servicenow OR index=itops) (event_type="user_create" OR event_type="sys_user_insert")
| rename target as user
| eval t_create=_time
| join type=left user [
  search (event_type="role_grant" OR event_type="sys_user_has_role_insert") "admin"
  | eval t_role=_time
]
| where t_role>=t_create AND t_role<=t_create+1800
| table t_create user actor t_role role details
```

#### 2) Agent activity preceding identity changes

```spl
(index=servicenow) (source="virtual_agent" OR source="now_assist")
| rename user_email as session_user
| eval t_session=_time
| join type=left session_user [
  search (event_type="user_create" OR event_type="role_grant" OR event_type="password_reset")
  | eval t_evt=_time
]
| where t_evt>=t_session AND t_evt<=t_session+1800
| stats values(event_type) as events values(target) as targets by session_user session_id
```

---

### D) Sentinel (KQL) Sketch

> Replace table names with your connector schema.

```kql
let window = 30m;
let AgentSessions = AgentSessionTable
  | project session_id, session_user=email, started_at=TimeGenerated;
let IdentityEvents = AuditTable
  | where EventType in ("user_create","role_grant","password_reset")
  | project evt_time=TimeGenerated, EventType, actor=Actor, target=Target, target_email=TargetEmail, details=Details;

AgentSessions
| join kind=inner IdentityEvents on $left.session_user == $right.target_email
| where evt_time between (started_at .. started_at + window)
| summarize events=make_set(EventType), targets=make_set(target), actors=make_set(actor) by session_user, session_id
```

---

## Analyst Notes (What to Look at Next)

If you hit on "new user + privileged role":

1. Pull full audit trail for the user (creation, role grants, password resets, MFA enrollment)
2. Identify the actor principal that performed the changes (system/integration user)
3. Pull adjacent agent session metadata (conversation/channel/source identity binding events)
4. Confirm patch status and disable/limit agent workflows pending remediation

---

## MITRE ATT&CK Mapping

> Reference: `attck_mapping.yaml` (to be populated with technique mappings and rationale)

**Suggested techniques:**
- T1078: Valid Accounts
- T1136: Create Account
- T1098: Account Manipulation
- T1134: Access Token Manipulation (if applicable to agent context switching)
- T1550: Use Alternate Authentication Material

---

## Indicators of Compromise (IOCs)

> Reference: `iocs.json` (expected mostly empty; fill from local investigations)

**Note:** This vulnerability is behavior-based rather than signature-based. IOCs should be derived from:
- Specific user accounts created through exploitation
- Integration/service account names used in suspicious activity
- Session IDs or conversation IDs associated with exploitation attempts
- IP addresses or source identifiers from confirmed incidents

Maintain organization-specific IOC lists based on observed threat actor TTPs in your environment.

---

## Additional Resources

- CVE-2025-12420 official advisory (link when available)
- ServiceNow security bulletins
- Vendor patch guidance
- Community threat intelligence sharing (ISAC, sector-specific)

---

## Version History

- v1.0 - Initial hunting package release
---
