# CASE-0002 — ATO + OAuth Identity Abuse (Synthetic)

Synthetic case study demonstrating account takeover detection through credential stuffing → successful auth → privilege escalation → mailbox rule creation and OAuth consent abuse.

---

## Overview

**Goal:** Model a realistic identity abuse / account takeover chain and produce:
- SQL query artifacts showing attack progression
- Scored set of suspicious accounts with rationales
- Analyst-ready investigation report

**Why synthetic:** Enables public sharing while maintaining reproducibility and privacy compliance.

---

## Threat Model

A threat actor executes a multi-stage account takeover:

### Stage 1: Initial Access Attempt
- **Credential stuffing / password spraying** from attacker infrastructure
- Multiple failed login attempts across accounts
- Targeting high-value accounts or spreading across many tenants

### Stage 2: Successful Compromise
- **Successful sign-in** from a **new ASN** / infrastructure (not previously seen for the account)
- Often follows immediately after failed attempts from same source

### Stage 3: Foothold Establishment
- **MFA device added** (SMS, authenticator app, hardware token)
- Upgrades authentication foothold to maintain persistence

### Stage 4: Abuse Actions
- **Mailbox rule creation** (forward emails, delete messages, auto-move to folders)
- **OAuth consent grants** to malicious third-party applications
- Enables data exfiltration and long-term access

---

## Telemetry

### Existing Tables
(Generated by `generate_dataset.py` for all cases)

- `accounts` - Account metadata and creation timestamps
- `orgs` - Organization/tenant information
- `devices` - Device fingerprints and metadata
- `sessions` - Authentication sessions
- `llm_requests` - API usage telemetry
- `rate_limit_events` - Throttling and policy actions
- `enrichment_ip` - IP/ASN enrichment data

### New Table: `identity_events`
(Introduced for CASE-0002)

**Purpose:** Unified identity, email, and OAuth events for ATO detection

**Schema:**
```sql
identity_events:
  - ts                   # Event timestamp (UTC)
  - account_id           # Target account
  - org_id               # Organization/tenant
  - event_type           # login_attempt | mfa_add | mailbox_rule | oauth_consent
  - outcome              # success | failure | blocked
  - ip                   # Source IP address
  - asn                  # AS number
  - device_fingerprint   # Device identifier
  - user_agent           # Browser/client user agent
  - details_json         # Event-specific metadata (rule name, OAuth scope, etc.)
```

---

## Investigation Pack

SQL queries in `sql/case0002/`:

### Attack Chain Detection

**`0002_01_failed_login_bursts.sql`**
- Identifies concentrated failed login attempts
- Detects password spraying patterns (many accounts from same source)
- Flags credential stuffing (same account, many attempts)

**`0002_02_new_asn_after_failures.sql`**
- Correlates successful logins from new ASNs
- Highlights accounts with prior failed attempts from same ASN
- Time-window analysis (success within N hours of failures)

**`0002_03_mfa_device_added.sql`**
- Tracks MFA device additions following successful auth
- Identifies devices added from suspicious ASNs
- Flags rapid MFA enrollment after compromise

**`0002_04_success_after_mfa.sql`**
- Monitors successful authentications using newly-added MFA
- Validates attacker can use the compromised MFA method
- Time proximity to initial compromise

**`0002_05_mailbox_rule_creation.sql`**
- Detects mailbox rules created post-compromise
- Flags forward/delete/auto-move rules
- Correlates with suspicious authentication timeline

**`0002_06_oauth_consent_grants.sql`**
- Identifies OAuth consent grants to third-party apps
- Tracks permissions/scopes granted (mail.read, files.readwrite, etc.)
- Flags grants following suspicious auth activity

### Synthesis Queries

**`0002_07_ato_chain_candidates.sql`**
- Combines signals across multiple stages
- Identifies accounts showing full attack chain progression
- Scores candidates by chain completeness and timing

**`0002_99_ato_rollup.sql`**
- Summary rollup of all ATO indicators
- Per-account risk aggregation
- Evidence compilation for reporting

---

## Quickstart

### Prerequisites

```powershell
# Activate virtual environment
.\.venv\Scripts\Activate.ps1
```

### Generate CASE-0002 Dataset

```powershell
# Using helper script (recommended)
.\scripts\gen_case.ps1 -Config "configs/case0002.yaml" -OutDir "datasets/output_case0002" -Clean
```

**Or run Python directly:**
```powershell
python .\python\generate_dataset.py --config .\configs\case0002.yaml --out .\datasets\output_case0002 --rows 500000
```

### Run Investigation Pipeline

```powershell
# Using helper script (recommended)
.\scripts\run_case.ps1 `
  -CaseDir "case_studies/CASE-0002-ato-identity-abuse" `
  -DataDir "datasets/output_case0002" `
  -SqlDir "sql/case0002" `
  -Strict
```

**Or run steps individually:**
```powershell
# Set variables
$CASEDIR = ".\case_studies\CASE-0002-ato-identity-abuse"
$SQLDIR  = ".\sql\case0002"
$DATA    = ".\datasets\output_case0002"
$DUCKDB  = ".\ai_abuse_case0002.duckdb"

# Run pipeline
python .\python\run_queries.py --duckdb $DUCKDB --data $DATA --sql $SQLDIR --case-dir $CASEDIR --strict
python .\python\scoring.py --case-dir $CASEDIR
python .\python\render_report.py --case-dir $CASEDIR
```

### Expected Outputs

**Artifacts (generated, gitignored):**
- `case_studies/CASE-0002-ato-identity-abuse/artifacts/0002_01_failed_login_bursts.csv`
- `case_studies/CASE-0002-ato-identity-abuse/artifacts/0002_02_new_asn_after_failures.csv`
- `case_studies/CASE-0002-ato-identity-abuse/artifacts/0002_03_mfa_device_added.csv`
- `case_studies/CASE-0002-ato-identity-abuse/artifacts/0002_04_success_after_mfa.csv`
- `case_studies/CASE-0002-ato-identity-abuse/artifacts/0002_05_mailbox_rule_creation.csv`
- `case_studies/CASE-0002-ato-identity-abuse/artifacts/0002_06_oauth_consent_grants.csv`
- `case_studies/CASE-0002-ato-identity-abuse/artifacts/0002_07_ato_chain_candidates.csv`
- `case_studies/CASE-0002-ato-identity-abuse/artifacts/0002_99_ato_rollup.csv`

**Investigation outputs:**
- `case_studies/CASE-0002-ato-identity-abuse/findings.json` (generated, gitignored)
- `case_studies/CASE-0002-ato-identity-abuse/scoring.json` (generated, gitignored)
- `case_studies/CASE-0002-ato-identity-abuse/REPORT.md` (generated, gitignored)

**Sanity check:**
```powershell
Test-Path "$CASEDIR\findings.json"
Test-Path "$CASEDIR\scoring.json"
Test-Path "$CASEDIR\REPORT.md"
Test-Path "$CASEDIR\artifacts\0002_07_ato_chain_candidates.csv"
```

---

## What to Look For

Indicators of successful account takeover when signals align:

### Primary Indicators

**Failed → Success Pattern**
- Multiple failed login attempts from an ASN
- Followed by successful login from same ASN within 1-24 hours
- New ASN for the account (not seen in past 30 days)

**MFA Manipulation**
- MFA device added shortly after suspicious successful auth
- Device added from same ASN as the compromise
- First successful login using the new MFA method

**Post-Compromise Actions**
- Mailbox rule created within hours/days of compromise
- OAuth consent granted to third-party app
- Rules/consents from same ASN or device as compromise

### Chain Completeness Score

**High Confidence (4-5 stages):**
- Failed attempts → Success from new ASN → MFA add → Mailbox rule → OAuth consent
- Full attack chain with tight temporal correlation

**Medium Confidence (3 stages):**
- Failed attempts → Success from new ASN → MFA add
- Partial chain, missing post-compromise abuse actions

**Low Confidence (1-2 stages):**
- Isolated failed attempts without progression
- New ASN success without prior failures (might be legitimate travel/VPN)

### Timing Windows

- **Burst window:** Failed attempts clustered within 15-60 minutes
- **Success window:** Success within 1-24 hours of failures
- **MFA window:** MFA add within 1-6 hours of success
- **Abuse window:** Mailbox rule/OAuth within 1-48 hours of MFA add

---

## Key Differences from CASE-0001

| Aspect | CASE-0001 (Coordinated Influence) | CASE-0002 (ATO/Identity Abuse) |
|--------|-----------------------------------|--------------------------------|
| **Pattern** | Many accounts coordinating via shared infra | Single account takeover with privilege escalation |
| **Telemetry** | Request-level logs (ASN, content, timing) | Identity event logs (auth, MFA, email, OAuth) |
| **Primary Signals** | Cross-tenant diversity, burst synchronization | Failed → success chains, MFA manipulation |
| **Time Scale** | Synchronized bursts across hours/days | Attack chain progression in minutes/hours |
| **Detection Focus** | Infrastructure reuse, template similarity | Temporal correlation, ASN novelty |

---

## Design Decisions

### Why a separate `identity_events` table?

**Unified event model:**
- Authentication, MFA, email rules, and OAuth consents are conceptually related
- Easier to query temporal correlations across event types
- Simpler to extend (add new identity event types without schema changes)

**Real-world mapping:**
- Maps to Microsoft Graph audit logs (`signInActivity`, `auditLogs`)
- Maps to Google Workspace admin logs (`login`, `token`, `email_settings`)
- Maps to Okta system logs (`authentication`, `mfa`, `app.oauth2.consent.grant`)

### Why case-specific SQL directory?

**Isolation:**
- CASE-0001 queries assume `llm_requests` table schema
- CASE-0002 queries assume `identity_events` table schema
- Keeps query logic separate to avoid schema conflicts

**Clarity:**
- `sql/` contains CASE-0001 queries (original case)
- `sql/case0002/` contains CASE-0002 queries (new case)
- Easy to understand which queries apply to which case

---

## Related Documentation

- Main repo README: `../../README.md`
- CASE-0001 README: `../CASE-0001-coordinated-influence/README.md`
- Config file: `../../configs/case0002.yaml`
- SQL queries: `../../sql/case0002/`
