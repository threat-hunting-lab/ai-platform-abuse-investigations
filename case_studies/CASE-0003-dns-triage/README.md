# CASE-0003 — DNS Triage + Redirect Chains (Synthetic)

Synthetic case study demonstrating DNS-based threat detection through explainable heuristics: suspicious TLDs, keyword hits, entropy analysis, and domain rarity. Includes redirect chain analysis via synthetic parent→child domain transitions.

---

## Overview

**Goal:** Model realistic DNS telemetry with embedded malicious patterns and produce:
- Ranked suspicious domains with explainable "why" columns
- Redirect chain clusters showing domain-to-domain transitions
- Exposed accounts touching risky DNS infrastructure
- Empirical evaluation metrics (precision/recall) against ground truth

**Why synthetic:** Enables public sharing, reproducible evaluation, and privacy compliance. Synthetic `is_malicious` ground truth allows measurable detection quality.

---

## Threat Model

DNS queries can reveal malicious infrastructure interactions:

### Stage 1: Initial Contact
- **Suspicious domains queried** from phishing emails, malvertising, or compromised sites
- Domains exhibit detectable patterns (cheap TLDs, phishing keywords, high entropy)
- Low-volume queries to rare/new domains

### Stage 2: Redirect Chains
- **Domain-to-domain transitions** (`parent_domain` → `base_domain`)
- Landing page redirects to payload delivery domains
- Multi-hop chains designed to evade simple blocklists

### Stage 3: Account Exposure
- Accounts/devices touching suspicious domains become **exposed**
- Risk accumulates across multiple suspicious lookups
- Exposure may correlate with downstream abuse (e.g., ATO attempts)

---

## Telemetry

### Existing Tables
(Generated by `generate_dataset.py` for all cases)

- `accounts` - Account metadata and creation timestamps
- `orgs` - Organization/tenant information
- `devices` - Device fingerprints and metadata

### New Table: `dns_events`
(Introduced for CASE-0003)

**Purpose:** Structured DNS telemetry with pre-computed heuristic flags for SQL-friendly detection

**Schema:**
```sql
dns_events:
  - ts                   # Event timestamp (UTC)
  - org_id               # Organization/tenant
  - account_id           # Account performing DNS query
  - device_fingerprint   # Device identifier
  
  - host_raw             # FQDN as queried (e.g., "login.secure-verify.xyz")
  - base_domain          # Extracted base domain (e.g., "secure-verify.xyz")
  - tld                  # Top-level domain (e.g., "xyz")
  - parent_domain        # Synthetic domain-to-domain edge (redirect chain)
  
  - suspicious_tld       # Boolean: TLD in suspicious list (.xyz, .tk, .top, etc.)
  - keyword_hit          # Boolean: Contains phishing keyword (login, verify, secure, etc.)
  - high_entropy         # Boolean: Shannon entropy > threshold (random-looking)
  - rare_domain          # Boolean: Query count <= threshold (computed in 2-pass)
  - score                # Int: Composite risk score (0-7, sum of weighted flags)
  
  - is_malicious         # Boolean: Synthetic ground truth for evaluation
```

**Key Design Decision: Pre-computed Heuristics**

Unlike CASE-0001/CASE-0002 where SQL queries do scoring, CASE-0003 applies heuristics **during generation** and outputs structured flags. This keeps SQL queries simple, explainable, and fast.

**parent_domain Semantic:**

"Synthetic domain-to-domain transition within a session to model redirect-like sequences. For example, if a user queries `landing.xyz` which then triggers a query to `payload.top`, `payload.top` would have `parent_domain='landing.xyz'`. Constraints: same `account_id` + `device_fingerprint`, time-ordered, depth-limited by `max_chain_len`."

---

## Investigation Pack

SQL queries in `sql/case0003/`:

### Detection Queries

**`0003_01_top_suspicious_domains.sql`**
- Rank suspicious domains by score + volume
- Include "why" columns (suspicious_tld_count, keyword_hit_count, high_entropy_count, rare_domain_count)
- Filter `score > 0` (only flagged domains)
- Sample evidence (arbitrary(host_raw))

**`0003_02_domain_chain_clusters.sql`**
- Find redirect-like sequences using `parent_domain` edges
- Count chain occurrences per parent→child pair
- Classify chain risk (high/medium/low based on avg child score)
- Filter chains appearing ≥3 times

**`0003_03_exposed_accounts.sql`**
- List accounts/devices with suspicious DNS exposure
- Aggregate risk per account (total_risk_score, distinct_suspicious_domains)
- Heuristic breakdown per account
- Time range (first/last suspicious query)

**`0003_04_heuristic_breakdown.sql`**
- Histogram of how often each heuristic fired
- Score distribution across all events
- Diagnostic view for tuning thresholds

### Synthesis Query

**`0003_99_rollup.sql`**
- Summary: total events, distinct domains, distinct accounts
- Flagged event counts
- **Empirical evaluation:** precision, recall, F1 (if `is_malicious` present)
- Confusion matrix components (TP, FP, FN)

---

## Quickstart

### Prerequisites

```powershell
# Activate virtual environment
.\.venv\Scripts\Activate.ps1
```

### Generate CASE-0003 Dataset

```powershell
# Step 1: Generate base dataset (accounts, orgs, devices, enrichment_ip)
python .\python\generate_dataset.py --config .\configs\case0003.yaml --out .\datasets\output_case0003

# Step 2: Generate DNS events (requires base dataset from Step 1)
python .\python\generate_dns_events.py --config .\configs\case0003.yaml --data .\datasets\output_case0003
```

**Expected output:**
- `datasets/output_case0003/dns_events.parquet` (~2-3M DNS events)
- `datasets/output_case0003/_dns_events_meta.json` (metadata: malicious count, chains, rare domains)

### Run Investigation Pipeline

```powershell
# Create artifacts directory
mkdir .\artifacts -Force | Out-Null

# Set variables
$CASEDIR = ".\case_studies\CASE-0003-dns-triage"
$SQLDIR  = ".\sql\case0003"
$DATA    = ".\datasets\output_case0003"
$DUCKDB  = ".\artifacts\ai_abuse_case0003.duckdb"

# Run queries
python .\python\run_queries.py --duckdb $DUCKDB --data $DATA --sql $SQLDIR --case-dir $CASEDIR --strict

# Score signals
python .\python\scoring.py --case-dir $CASEDIR

# Render report
python .\python\render_report.py --case-dir $CASEDIR
```

### Expected Outputs

**Artifacts (generated, gitignored):**
- `case_studies/CASE-0003-dns-triage/artifacts/0003_01_top_suspicious_domains.csv`
- `case_studies/CASE-0003-dns-triage/artifacts/0003_02_domain_chain_clusters.csv`
- `case_studies/CASE-0003-dns-triage/artifacts/0003_03_exposed_accounts.csv`
- `case_studies/CASE-0003-dns-triage/artifacts/0003_04_heuristic_breakdown.csv`
- `case_studies/CASE-0003-dns-triage/artifacts/0003_99_rollup.csv`

**Investigation outputs:**
- `case_studies/CASE-0003-dns-triage/findings.json` (generated, gitignored)
- `case_studies/CASE-0003-dns-triage/scoring.json` (generated, gitignored)
- `case_studies/CASE-0003-dns-triage/REPORT.md` (generated, gitignored)

**Sanity check:**
```powershell
Test-Path "$CASEDIR\findings.json"
Test-Path "$CASEDIR\scoring.json"
Test-Path "$CASEDIR\REPORT.md"
Test-Path "$CASEDIR\artifacts\0003_99_rollup.csv"
```

---

## What to Look For

Indicators of malicious DNS activity when signals align:

### Primary Indicators

**High-Risk Domains (score ≥ 5)**
- Multiple heuristics triggered simultaneously
- Suspicious TLD + phishing keyword + high entropy + rare domain
- Strong signal for malware C2, phishing, or scam infrastructure

**Redirect Chains**
- Parent domain with low/medium score → child domain with high score
- Common chain patterns (many accounts following same redirect path)
- Malvertising / drive-by download sequences

**Account Exposure**
- Accounts touching 5+ distinct suspicious domains
- High total risk score accumulation
- Multiple heuristic types triggered (not just one)

### Evaluation Metrics

**Precision (TP / (TP + FP))**
- What fraction of flagged events are truly malicious?
- High precision (>0.80) = low false positive rate
- Tunable via score threshold adjustment

**Recall (TP / (TP + FN))**
- What fraction of malicious events did we catch?
- High recall (>0.70) = catching most threats
- Trade-off with precision (higher threshold → lower recall)

**F1 Score (2 × precision × recall / (precision + recall))**
- Harmonic mean balancing precision and recall
- Good F1 (>0.75) = strong overall detection quality

### Heuristic Tuning

Review `0003_04_heuristic_breakdown.csv` to understand:
- Which heuristics fire most often (high false positive sources?)
- Score distribution (are most events score=0, or spread across 1-7?)
- Adjust config thresholds (entropy_threshold, rare_domain_threshold) if needed

---

## Key Differences from CASE-0001/CASE-0002

| Aspect | CASE-0001 (Coordinated Influence) | CASE-0002 (ATO/Identity Abuse) | CASE-0003 (DNS Triage) |
|--------|-----------------------------------|--------------------------------|------------------------|
| **Pattern** | Many accounts coordinating via shared infra | Single account takeover with privilege escalation | Malicious domain detection with redirect chains |
| **Telemetry** | Request-level logs (ASN, content, timing) | Identity event logs (auth, MFA, email, OAuth) | DNS query logs (domains, heuristics, chains) |
| **Primary Signals** | Cross-tenant diversity, burst synchronization | Failed → success chains, MFA manipulation | Suspicious TLD/keyword/entropy, redirect chains |
| **Scoring** | SQL-computed aggregations | SQL-computed temporal correlations | Pre-computed flags in data (SQL is simple lookup) |
| **Evaluation** | Qualitative (campaign detection) | Qualitative (ATO chain completeness) | **Quantitative (precision/recall vs ground truth)** |

---

## Design Decisions

### Why pre-compute heuristics in the generator?

**SQL simplicity:**
- Queries just filter and aggregate boolean flags
- No complex entropy calculations or keyword regex in SQL
- Easier to review and debug detection logic

**Performance:**
- Flags computed once during generation, not per query
- DuckDB can efficiently filter on boolean columns
- Faster iteration during investigation

**Explainability:**
- Each event row shows exactly which heuristics triggered
- "Why" columns in SQL are simple SUM(CASE WHEN flag THEN 1...) counts
- Non-technical reviewers can understand boolean flags

### Why 2-pass rare_domain computation?

**Logical necessity:**
- Can't know if a domain is "rare" until counting all occurrences
- First pass: generate all events with `rare_domain=False`
- Second pass: count domains, update flag where count ≤ threshold

**Correctness:**
- Ensures rare_domain reflects global frequency, not per-account
- Prevents inconsistent scores across events for same domain

### Why parent_domain instead of HTTP referrer?

**DNS semantics:**
- DNS doesn't have native "referrer" concept (HTTP-specific)
- `parent_domain` models synthetic session-based chains
- Clearer naming: "this domain was queried after parent_domain"

**Coherence constraints:**
- Same account_id + device_fingerprint (within-session transitions)
- Time-ordered (parent timestamp < child timestamp)
- Depth-limited by max_chain_len (prevents infinite chains)

### Why case-specific data directory?

**Isolation:**
- CASE-0001 uses `datasets/output`
- CASE-0002 uses `datasets/output_case0002`
- CASE-0003 uses `datasets/output_case0003`
- Prevents table name collisions and data mixing

**Clarity:**
- Each case's parquet files stay together
- Easy to clean up or regenerate one case without affecting others

### Why ground truth (is_malicious)?

**Empirical validation:**
- Synthetic cases usually lack measurable success criteria
- `is_malicious` enables precision/recall calculation
- Supports threshold tuning (e.g., "score ≥ 4" vs "score ≥ 3")

**Interview-friendly:**
- Shows understanding of detection quality metrics
- Demonstrates ability to validate detection logic systematically
- Proves heuristics work as intended (or reveals gaps)

---

## Heuristic Details

### Suspicious TLD List

Config: `dns_events.suspicious_tlds`

Common cheap/abused TLDs:
- **Ultra-cheap gTLDs:** .xyz, .top, .icu, .club, .link, .click, .tk, .cf, .ml, .ga, .gq
- **Scam verticals:** .win, .loan, .date, .party, .racing, .bid, .trade
- **Disposable / free:** .tk, .cf, .ml, .ga, .gq, .pw (Freenom TLDs)

**Weight:** 2 (medium confidence - many legitimate sites use .xyz/.top)

### Keyword Hit

Config: `dns_events.keyword_indicators`

Phishing-related keywords:
- **Auth/login:** login, secure, verification, verify, update, account, auth
- **Support:** support, helpdesk
- **Brands:** office, microsoft, apple, paypal, bank
- **Crypto/finance:** wallet, crypto, giftcard

**Weight:** 3 (high confidence - keyword + other signals = strong indicator)

### High Entropy

Config: `dns_events.entropy_threshold` (default: 3.5)

- **Shannon entropy** of base_domain (dots removed)
- Random-looking strings score higher (e.g., "xk9m2p4zq8.xyz")
- Legitimate domains usually have lower entropy (e.g., "google.com")

**Weight:** 1 (weak signal alone - many CDNs have high entropy subdomains)

### Rare Domain

Config: `dns_events.rare_domain_threshold` (default: 5)

- **Query count ≤ threshold** across entire dataset
- Newly registered or very low-traffic domains
- C2 domains, one-off phishing sites

**Weight:** 1 (weak signal alone - many legitimate new sites are rare)

### Composite Score

```
score = (suspicious_tld * 2) + (keyword_hit * 3) + (high_entropy * 1) + (rare_domain * 1)
```

**Range:** 0-7

**Interpretation:**
- 0: Benign (no flags triggered)
- 1-2: Low risk (single weak signal)
- 3-4: Medium risk (multiple signals or one strong signal)
- 5-7: High risk (multiple signals including keyword hit)

---

## Extending CASE-0003

### Optional: ATO Correlation

**Stretch goal (not in MVP):**

Add `0003_05_exposure_then_identity_abuse.sql` to correlate DNS exposure with downstream ATO attempts:

```sql
-- Find accounts with suspicious DNS → failed login bursts within 48h
WITH dns_exposed AS (
  SELECT account_id, MAX(ts) AS last_suspicious_dns
  FROM dns_events
  WHERE score >= 4
  GROUP BY account_id
),
failed_logins AS (
  SELECT account_id, MIN(ts) AS first_failed_login
  FROM identity_events
  WHERE event_type = 'auth.signin' AND outcome = 'failure'
  GROUP BY account_id
)
SELECT
  d.account_id,
  d.last_suspicious_dns,
  f.first_failed_login,
  (f.first_failed_login - d.last_suspicious_dns) AS time_delta_hours
FROM dns_exposed d
JOIN failed_logins f ON d.account_id = f.account_id
WHERE f.first_failed_login BETWEEN d.last_suspicious_dns AND d.last_suspicious_dns + INTERVAL '48 hours'
ORDER BY time_delta_hours;
```

**Requires:**
- Both `dns_events.parquet` and `identity_events.parquet` exist
- Stable join keys (account_id, timestamp alignment)

### Threshold Tuning

Modify `configs/case0003.yaml`:

```yaml
dns_events:
  entropy_threshold: 4.0        # Increase for fewer false positives
  rare_domain_threshold: 10     # Increase to flag only very rare domains
  score_weights:
    suspicious_tld: 3           # Boost TLD weight if seeing lots of .xyz abuse
    keyword_hit: 4              # Increase keyword weight for higher confidence
```

Re-run generator to apply new thresholds, then compare precision/recall.

---

## Related Documentation

- Main repo README: `../../README.md`
- CASE-0001 README: `../CASE-0001-coordinated-influence/README.md`
- CASE-0002 README: `../CASE-0002-ato-identity-abuse/README.md`
- Config file: `../../configs/case0003.yaml`
- SQL queries: `../../sql/case0003/`
- Generator: `../../python/generate_dns_events.py`
